#pragma once

"#define P(x,y)texture(x,y).rgb\n"
"\n#define e_t_div 16.0\n"
"\n#define s_steps 16\n"
"float v(vec3 v)"
"{"
  "return v.y*(.587/.299)+v.x;"
"}"
"vec3 v(sampler2D u,vec2 y,vec2 m)"
"{"
  "vec3 s=P(u,y+vec2(0,-m.y)),x=P(u,y+vec2(-m.x,0)),d=P(u,y),l=P(u,y+vec2(m.x,0)),n=P(u,y+vec2(0,m.y));"
  "float i=v(s),a=v(x),e=v(d),k=v(l),f=v(n),r=min(e,min(min(i,a),min(f,k))),C=max(e,max(max(i,a),max(f,k))),g=C-r;"
  "if(g<max(1./e_t_div,C*.125))"
    "return d;"
  "vec3 b=s+x+d+l+n;"
  "float F=(i+a+k+f)*.25,A=abs(F-e),c=max(0.,A/g-.25)*(1./.75);"
  "c=min(.75,c);"
  "vec3 T=P(u,y+vec2(-m.x,-m.y)),p=P(u,y+vec2(m.x,-m.y)),t=P(u,y+vec2(-m.x,m.y)),h=P(u,y+vec2(m.xy));"
  "b+=T+p+t+h;"
  "b*=vec3(1./9.);"
  "float o=v(T),B=v(p),D=v(t),E=v(h),G=abs(.25*o+-.5*i+.25*B)+abs(.5*a+-1.*e+.5*k)+abs(.25*D+-.5*f+.25*E),H=abs(.25*o+-.5*a+.25*D)+abs(.5*i+-1.*e+.5*f)+abs(.25*B+-.5*k+.25*E);"
  "bool V=H>=G;"
  "float I=V?"
    "-m.y:"
    "-m.x;"
  "if(!V)"
    "i=a,f=k;"
  "float w=abs(i-e),J=abs(f-e);"
  "i=(i+e)*.5;"
  "f=(f+e)*.5;"
  "if(w<J)"
    "i=f,i=f,w=J,I*=-1.;"
  "vec2 K;"
  "K.x=y.x+(V?"
    "0.:"
    "I*.5);"
  "K.y=y.y+(V?"
    "I*.5:"
    "0.);"
  "w*=.25;"
  "vec2 L=K,M=V?"
    "vec2(m.x,0):"
    "vec2(0,m.y);"
  "float N=i,O=i;"
  "bool Q=false,R=false;"
  "K+=M*vec2(-1);"
  "L+=M*vec2(1);"
  "for(int S=0;S<s_steps;S++)"
    "{"
      "if(!Q)"
        "N=v(P(u,K.xy));"
      "if(!R)"
        "O=v(P(u,L.xy));"
      "Q=Q||abs(N-i)>=w;"
      "R=R||abs(O-i)>=w;"
      "if(Q&&R)"
        "break;"
      "if(!Q)"
        "K-=M;"
      "if(!R)"
        "L+=M;"
    "}"
  "float S=V?"
    "y.x-K.x:"
    "y.y-K.y,U=V?"
    "L.x-y.x:"
    "L.y-y.y;"
  "bool W=S<U;"
  "N=W?"
    "N:"
    "O;"
  "if(e-i<0.==N-i<0.)"
    "I=0.;"
  "float X=U+S;"
  "S=W?"
    "S:"
    "U;"
  "float Y=(.5+S*(-1./X))*I;"
  "vec3 Z=P(u,vec2(y.x+(V?"
    "0.:"
    "Y),y.y+(V?"
    "Y:"
    "0.)));"
  "return vec3(-c)*Z+(b*vec3(c)+Z);"
"}"
"\n#ifdef VERTEX\n"
"layout(location=0) in vec2 Position;"
"layout(location=1) in vec2 TexCoord;"
"layout(location=5) in uvec4 Flags;"
"uniform mat4 u_MVP;"
"out vec2 v_TexCoord;"
"flat out uvec4 v_Flags;"
"void main()"
"{"
  "gl_Position=u_MVP*vec4(Position,0,1);"
  "v_TexCoord=TexCoord;"
  "v_Flags=Flags;"
"}"
"\n#elif FRAGMENT\n"
"layout(location=0) out vec4 FragColor;layout(std140) uniform ubo_Metrics{float u_SharpStrength;float u_SharpClamp;float u_Radius;float pad1;vec2 u_RelSize;};"
"uniform sampler2D u_Texture0,u_Texture1;"
"in vec2 v_TexCoord;"
"flat in uvec4 v_Flags;"
"\n#define CoefLuma vec3(0.2126,0.7152,0.0722)\n"
"vec3 v(sampler2D u,vec2 y)"
"{"
  "vec3 i=P(u,y),v=P(u,y+u_RelSize*u_Radius),a=P(u,y-u_RelSize*u_Radius),m=CoefLuma*u_SharpStrength*1.5;"
  "vec4 e=vec4(m*(.5/u_SharpClamp),.5);"
  "float x=u_SharpClamp*2.*clamp(dot(vec4(i-(v+a)/2.,1),e),0.,1.)-u_SharpClamp;"
  "return clamp(i+x,0.,1.);"
"}"
"void main()"
"{"
  "switch(v_Flags.x){"
    "case 0u:"
      "FragColor=vec4(v(u_Texture0,v_TexCoord),1);"
      "break;"
    "case 1u:"
      "FragColor=vec4(v(u_Texture1,v_TexCoord),1);"
      "break;"
    "case 2u:"
      "FragColor=vec4(v(u_Texture0,v_TexCoord,u_RelSize),1);"
      "break;"
    "case 3u:"
      "FragColor=vec4(P(u_Texture0,v_TexCoord),1);"
      "break;"
  "}"
"}"
"\n#elif COMPUTE\n"
"layout(local_size_x=16,local_size_y=16)in;"
"uniform sampler2D u_InTexture;"
"writeonly uniform image2D u_OutTexture;"
"uniform int u_Flag=0;"
"void main()"
"{"
  "ivec2 u=ivec2(gl_GlobalInvocationID.xy);"
  "vec2 y=vec2(textureSize(u_InTexture,0)),x=(vec2(u)+vec2(.5))/y;"
  "vec3 i=v(u_InTexture,x,vec2(1)/y);"
  "imageStore(u_OutTexture,u,vec4(i,1));"
"}"
"\n#endif"